#!/usr/bin/env python

import numpy as np
import MDAnalysis as mda
import sys
import getopt
import matplotlib.pyplot as pyp
import pandas as pd
import plotly as py
import plotly.offline as offline #import download_plotlyjs, init_notebook_mode, plot, iplot
import plotly.graph_objs as go
import os
import time 
import shutil 

instructions = "This program will print the angles between the z axis and one or two vectors specified by the user. vec1 and vec2 are specified giving the a couple of atoms \"A1 A2\" that defines the vector. The program is invoked as:  \n" + sys.argv[0] + "  --vec1=\"A1 A2\" --vec2=\"A3 A4\" -s file.tpr -f traj.xtc -o outputname\n \n This will generate a file angles_outputname.dat that contains the angles vs time and a angles_outputname.png which plots them vs time"
print("\n")
print(instructions)
print("\n")

try:
    options, files = getopt.getopt(sys.argv[1:], 's:f:o:',['vec1=','vec2=','s=','f=','o='])  	#here i read the options and assign the values to the "options" variable  
except getopt.GetoptError:
    print("\n")
    sys.stderr.write("Error: you probably inserted a flag that isn't there or some files are missing")
    print("\n")
    raise SystemExit

for opt, val in options:  						#here i assign each option to a variable to use in the script	
    
    if opt == '--vec1':
        vec1=val
            
    if opt == '--vec2':
        vec2=val
    
    if opt == '-s':
        topol=val.lstrip()
    
    if opt == '-f':
        traj=val.lstrip()
    
    if opt == '-o':
	outputname=val.lstrip()

u=mda.Universe(topol, traj)
Angle1=[]
Angle2=[]
Ts=[]

f=open(outputname+".dat", 'w')                     #open the file with append option. CORRECT THIS WITH WRITE!
f.write("### This file was generated by the invoking: "+sys.argv[0]+" --vec1=\"%s\" --vec2=\"%s\"  -s %s -f %s -o %s  \n \n" % (vec1, vec2, topol , traj , outputname))
for ts in u.trajectory:
  pos_at_1=np.array(list(u.select_atoms("bynum "+str(vec1)).positions[0]))  #select the atoms
  pos_at_2=np.array(list(u.select_atoms("bynum "+str(vec1)).positions[1])) 
  pos_at_3=np.array(list(u.select_atoms("bynum "+str(vec2)).positions[0]))
  pos_at_4=np.array(list(u.select_atoms("bynum "+str(vec2)).positions[1]))
  #print(pos_at_1)
  vec_z= np.array([0,0,1])                              #define z axis and vec1
  vec_1= np.array(pos_at_2 - pos_at_1)                         #this will be vec1
  vec_temp= np.array(pos_at_4 - pos_at_3)                      #define a temporary vec_temp for the cross product to find vec_2 
  vec_2= np.cross(vec_1,vec_temp)                       #->remember here that a x b =! b x a, b x a = -a x b. So this vector should be pointing INTO the plane of the molecule
  norm_vec_z= np.sqrt(np.dot(vec_z, vec_z))             #the norms are for calculating the angles 
  norm_vec_1= np.sqrt(np.dot(vec_1, vec_1))
  norm_vec_2= np.sqrt(np.dot(vec_2, vec_2))
  angle_1=np.rad2deg(np.arccos((np.dot(vec_1,vec_z))/(norm_vec_1*norm_vec_z))) #angles are calculated with the formula
  angle_2=np.rad2deg(np.arccos((np.dot(vec_2,vec_z))/(norm_vec_2*norm_vec_z))) #to find an angle between 2 vectors
  Angle1.append(angle_1)
  Angle2.append(angle_2)
  Ts.append(ts.time)
#  if ts.time == 0 :                            #if its the first step it empties the file
#    f.seek(0)                                  #with this
#    f.truncate()                               #and this line
#    f.write("### This file was generated by the invoking: "+sys.argv[0]+" --vec1=\"%s\" --vec2=\"%s\"  -s %s -f %s -o %s  \n \n" % (vec1, vec2, topol , traj , outputname)) #spaces are just left inbetween 
  f.write("%s\t%s\t%s\n" % (int(ts.time), float(angle_1), float(angle_2))) #spaces are just left inbetween 
f.close() 

##PLOT THE GRAPH
df=pd.read_table(outputname+".dat",skiprows=1 ,names=["time","angle1","angle2"])
prob_matrix=np.zeros((181,181))

for index, line in df.iterrows():
        prob_matrix[int(round(line["angle1"])),int(round(line["angle2"]))]+=1

prob_matrix=prob_matrix/float(df.shape[0])
for i in range(181):
    for j in range(181):
        if i == 0:
            i_ndex=0.25
        if j == 0:
            j_ndex=0.25
        if i == 180:
            i_ndex=179.75
        if j == 180:
            j_ndex=179.75
        else:
            i_ndex=i
            j_ndex=j

        radicand=(1-(np.cos(np.deg2rad(i_ndex))**2)-(np.cos(np.deg2rad(j_ndex))**2))
        if (abs(np.deg2rad(i) - np.deg2rad(90)) + abs(np.deg2rad(j)-np.deg2rad(90))) <= np.deg2rad(90):
            if radicand < 0:
                radicand=0
            if (np.sin(np.deg2rad(i_ndex))*np.sin(np.deg2rad(j_ndex))) != 0:
                prob_matrix[i,j]= prob_matrix[i,j] * np.sqrt(radicand)/(np.sin(np.deg2rad(i_ndex))*np.sin(np.deg2rad(j_ndex)))

dfmat=pd.DataFrame(prob_matrix)
data = [
    go.Surface(
        z=dfmat.as_matrix()
    )
]
layout = go.Layout(
    title='Prob_map'
)
fig = go.Figure(data=data, layout=layout)
py.offline.plot(fig, image='png', image_filename=outputname)

#move the file to this folder cause plotly is dumb
dload = os.path.expanduser('~/Downloads')
current_dir=os.getcwd()
#time.sleep(5)
#shutil.move(dload+"/"+outputname+".png", current_dir+"/"+outputname+".png")
while not os.path.exists(dload+"/"+outputname+".png"):
    time.sleep(1)
shutil.move(dload+"/"+outputname+".png", current_dir+"/"+outputname+".png")

